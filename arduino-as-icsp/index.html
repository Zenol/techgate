<!DOCTYPE html>
<html lang="en-us">

  <head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <meta name="description" content="Jeremy Cochoy's personal website.">
  <meta name="author" content="Jeremy Cochoy">

  <title>
    
      Arduino as ICSP - Programmeur pour microcontrôleurs atmel &middot; Jeremy Cochoy
    
  </title>

  <!-- CSS -->
  <link href="/public/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
  	<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
  	<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
	<![endif]-->

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  <!-- Custom styles for this template -->
  <link href="/public/style.css" rel="stylesheet">

  <!-- Maths equations -->
  <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      processEscapes: true
    }
  });
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
</head>


  <body>

    <!-- Fixed navbar -->
<nav class="navbar navbar-default navbar-fixed-top">
 <div class="container">
   <div class="navbar-header">
     <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
 <span class="sr-only">Toggle navigation</span>
 <span class="icon-bar"></span>
 <span class="icon-bar"></span>
 <span class="icon-bar"></span>
     </button>
     <a class="navbar-brand" href="/">Jeremy Cochoy</a>
   </div>
   <div id="navbar" class="collapse navbar-collapse">
     <ul class="nav navbar-nav">
 <li><a href="/blog/">Blog</a></li>
 <li><a href="/resume/">Resume</a></li>
 <li role="separator" class="divider"></li>
 <li><a href="/research/">Research</a></li>
 <li><a href="/talks/">Talks</a></li>
 <li><a href="/teaching/">Teaching</a></li>
 <li><a href="/music/">Music</a></li>
 <li class="dropdown">
   <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">More <span class="caret"></span></a>
   <ul class="dropdown-menu">
     <li><a href="/hyper-flop/">Hyper-Flop</a></li>
     <li role="separator" class="divider"></li>
     <li><a href="/pdfs/">PDFs & Talks</a></li>
     <li><a href="/agreg-dev/">Agregation de mathématique</a></li>
     <li role="separator" class="divider"></li>
     <li><a href="https://github.com/jeremycochoy/sednl" alt="SEDNL Github">SEDNL (Github)</a></li>
     <li><a href="http://sednl.zenol.fr" alt="Simple Event Driven Network Library">SEDNL</a></li>
           <li role="separator" class="divider"></li>
           <li><a href="/gb-doc">GameBoy Emulator Documentation</a></li>
   </ul>
 </li>
     </ul>
   </div><!--/.nav-collapse -->
 </div>
</nav>


    <div class="container">
      <div class="post">
  <h1 class="post-title">Arduino as ICSP - Programmeur pour microcontrôleurs atmel</h1>
  <span class="post-date">25 May 2012</span>
  <h2 id="icsp">ICSP?</h2>

<p>ICSP (In-Circuit Serial Programming) ou encore ISP est le nom donné à l’interface de programmation des microcontroleurs pouvant être reprogrammé <em>in situ</em>. C’est le cas des AVR de chez Atmels, dont figure la très célèbre famille des Atméga (Atmega328P pour la carte arduino uno), mais aussi les petits ATtiny, qui n’ont que peux à envier aux atméga, puisque pouvant surpasser la cadence des seconds (20Mhz pour l’attiny84 et l’attiny85).</p>

<p>Si vous disposez d’une carte arduino, vous ne programmez pas votre microcontroleur grace à l’ICSP, mais via le bootloader arduino qui a chaque démarrage (appuis sur reset si vous préférez, ou mise sous tension) attend quelques instant une éventuelle communication sur les pins 0 et 1 (RX et TX) avant de finalement lancer votre programme (aussi appelé sketch). Vous l’aurez comprit, la programmation d’une arduino se fait en effectuant un reset et en transmettant les données sous la forme d’une <a href="http://fr.wikipedia.org/wiki/UART">liaison série asynchrone</a>.</p>

<p>L’inconvénient de cette méthode, est qu’un microcontroleur “brute de fonderie” ne permet pas une telle chose (C’est le cas quand vous achetez directement des PIC, PICAXE ou ATMegas au constructeur) et qu’il faut donc charger le bootloader arduino.</p>

<p>Une autre raison, plus pragmatique, est que le bootloader arduino mange tout de même plus d’une page mémoire, et que pour certaines applications – une aventure qui ne m’est pour le moment pas arrivé – il peut être utile de gagner quelques précieux octets.</p>

<p>La programmation atmel se fait via une interface SPI pour <a href="http://en.wikipedia.org/wiki/Serial_Peripheral_Interface_Bus">Serial Peripherical Interface</a> (c’est à ce moment que l’ordre des lettres d’un acronyme devien crucial pour ne pas se retrouver confus).</p>

<h3 id="arduino-as-isp">Arduino as ISP</h3>

<p>Par chance, des gens bien veillant se sont sacrifié pour implémenter un programmateur ISP à travers la carte arduino. Concrètement, l’utilisation du sketch Arduino As ISP (disponible dans la rubrique ‘exemples’ de l’IDE arduino) permet de transformer la carte arduino en un programmateur ISP, dialoguant avec le PC d’une façon <em>standard</em> – compenez que les utilitaires pour avr comme avrdude arrivent a communiquer avec l’arduino – et pouvant pogrammez un microcontroleur atmel… si vous avez de la chance.</p>

<p>Retenez qu’un programmateur ISP d’atmels doit avoir le contrôle sur 4 pins du composant : Le pin reset, car le protocole de programmation demande de pouvoir faire des <em>choses bizarres</em> avec ce dernier, et les 3 pins SPI (MISO, MOSI et SCLK. On n’utilise pas le SS). Le cablage de votre arduino avec un atmega est décrit :</p>

<ul>
  <li>Dans le code de l’Arduino As ISP; les pins utilisé par le sketch sont indiqué.
Y figure aussi au port 9 un “heartbeat” qui permet de savoir quand votre sketch
a planté – ce qui arrive plus souvent qu’on le souhaiterais.</li>
  <li>Su le <a href="http://arduino.cc/en/Tutorial/ArduinoToBreadboard">site officiel arduino</a>, dont l’image suivante est tirée.</li>
</ul>

<p>Voici donc le schéma d’un montage avec votre arduino comportant le sketh Arduino As ISP, pour programmer un atmega328p (Si vous voulez programmer un autre atmel, il suffit de rechercher les port MOSI, MISO, SCLK et reset, puis de cabler comme sur l’atmega328p).</p>

<p><img src="data/BreadboardAVR.png" alt="Montage arduino" /></p>

<p>Sachez que, pour ma part, j’ai du modifier le sketch d’Arduino As ISP, en changeant le baud-rate de la liaison série (avec le PC) à 9600 (par défaut 12900), pour que tout se passe bien. (La pemiere ligne de setup() :   Serial.begin(19200); )</p>

<h3 id="hologe">Hologe?</h3>

<p>Si la résistance de pull-up sur le reset n’est pas obligatoire, pour un microcontroleur sortie de l’usine, il se peut que vous aillez besoin d’une horloge externe. L’horloge externe ou interne se configure via les fuses (fusibles), des registres spéciaux que le peut modifier… via ICSP – donc, une fois que vous aurez réussi à faire fonctionner tout ce beau monde, ce qui ne nous aide pas.</p>

<p>Pour ma part, j’ai été obligé d’ajouter une horloge externe pour avoir une réponse du microcontroleur lorsqu’on lui demande d’épeler son nom (signature du composant). Un simple crystal 16MHz avec deux condensateurs 22pF – non, ça ne marche pas avec 22nF, ce n’est pas faute d’avoir essayé… – feras l’affaire. Il est fort probable qu’un crystal à 8MHz convienne aussi – avec les mêmes condensateurs.</p>

<h3 id="lets-go">Let’s GO!</h3>

<p>Votre sketch est sur votre arduino, votre circuit est opérationnel, vous avez vérifier chaque câble, chaque branchement, et relut le schéma 8 fois? Bien, alors revérifiez encore une fois dans le doute.</p>

<p>Installez la suite AVRtools (WinAVR pour windows, votre gestionnaire de packets sous linux, et pour les autres, à vous de vous débrouiller :D ). Ne pas hésiter à consulter la <a href="http://www.nongnu.org/avr-libc/user-manual/using_tools.html">documentation de AVRtools</a>.</p>

<p>Lancez avrdude, avec une commande de cette forme :</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>avrdude <span class="nt">-p</span> atmega328p <span class="nt">-c</span> avrisp <span class="nt">-P</span> com4 <span class="nt">-b</span> 9600
</code></pre></div></div>
<p>Où vous remplacez atmega328p par votre microcontroleur, et com4 par votre port. Pensez aussi a entrer le baud-rate (-b) figurant dans le code du sketch Arduino As ISP. Si tout vas bien (Vous devez obtenir une réponse de votre microcontroleur, et les noms attendu et reçu doivent correspondre), vous pouvez alors envoyer un sketch avec :</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>avrdude <span class="nt">-p</span> atmega328p <span class="nt">-c</span> avrisp <span class="nt">-P</span> com4 <span class="nt">-b</span> 9600 <span class="nt">-U</span> flash:w:sketch.hex
</code></pre></div></div>
<p>Pour plus de détailles sur avrdude, référez vous à la documentation, ou bien
au site de <a href="http://www.ladyada.net/learn/avr/avrdude.html">LadyAda</a>.</p>

<p>Sur ce, amusez vous bien :)</p>

<p><strong>Nb :</strong> Pour calculer les fuses, j’utilise <a href="http://www.engbedded.com/fusecalc">FuseCalc</a>.</p>


</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/what-is-wrong-with-the-object-paradigm/">
            What is wrong with the object paradigm ?
            <small>17 Feb 2017</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/boost-property-tree/">
            How to use boost::property_tree to load and write JSON
            <small>21 Dec 2015</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/an-alternative-error-handling-strategy-cpp/">
            An alternative error handling strategy for C++
            <small>27 Aug 2013</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

    </div>

    
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-10762787-1', 'auto');
    ga('send', 'pageview');
</script>
    

    <footer class="footer">
  <hr/>
  <div class="container">
    <div class="row">
      <p class="text-muted col-sm-10 text-center">
            <span class="sidebar-nav-item small">Make a donation. 😇</span>
            <span class="sidebar-nav-item x-small">BTC: <a href="bitcoin:1JcME7DSCw8b83nEGFKUYTKE4LM8aX4dhJ">1JcME7DSCw8b83nEGFKUYTKE4LM8aX4dhJ</a></span>
            <span class="sidebar-nav-item x-small">ETH: <a href="ethereum:eA22ADf19f20D618D8EF66E4704C540A10708F1F">eA22ADf19f20D618D8EF66E4704C540A10708F1F</a></span>
      </p>
      <p class="col-sm-2">
        <a class="twitter-share-button col-sm"
           href="https://twitter.com/share"
           data-via="Zenol42">
          Tweet
        </a>
      </p>
    </div>
  </div>
</footer>

<!-- Bootstrap core JavaScript
================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/bootstrap/js/vendor/jquery.min.js"><\/script>')</script>
<script src="/public/bootstrap/js/bootstrap.min.js"></script>

<!-- Twitter sharing button loader -->
<script>
  window.twttr = (function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0],
      t = window.twttr || {};
    if (d.getElementById(id)) return t;
    js = d.createElement(s);
    js.id = id;
    js.src = "https://platform.twitter.com/widgets.js";
    fjs.parentNode.insertBefore(js, fjs);

    t._e = [];
    t.ready = function(f) {
      t._e.push(f);
    };

    return t;
  }(document, "script", "twitter-wjs"));
</script>

  </body>
</html>
